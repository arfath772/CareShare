<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Panel â€” Care & Share</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <style>
        :root {
            --primary-color: #00A0E3;
            --secondary-color: #000000;
            --text-dark: #1E293B;
            --donate-color: #198754;
            --exchange-color: #ffc107;
            --resell-color: #0d6efd;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f1f5f9;
            color: var(--text-dark);
            padding-top: 80px;
        }
        .navbar-custom {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
            font-size: 1.6rem;
        }
        .nav-link { color: var(--text-dark) !important; }
        .nav-link.active { color: var(--primary-color) !important; font-weight: 600; }

        .admin-header {
            background: linear-gradient(135deg, var(--primary-color), #0078b5);
            color: white;
            padding: 60px 0;
            margin-bottom: 30px;
        }
        .admin-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            border-top: 3px solid var(--primary-color);
        }
        .section-header {
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        .section-header h3 {
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
            border-left: 4px solid var(--primary-color);
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        .stat-label { color: #64748b; font-weight: 500; }
        .table-responsive {
            margin-top: 20px;
        }
        .table thead th {
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }
        .product-image {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            object-fit: cover;
            border: 1px solid #e2e8f0;
        }
        .badge { font-size: 0.8rem; padding: 0.4em 0.7em; }
        .btn-sm { padding: 0.25rem 0.6rem; font-size: 0.8rem; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light navbar-custom fixed-top shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="/">
            <span style="font-weight: 300;">CARE</span> <strong>&</strong> <span style="font-weight: 300;">SHARE</span>
        </a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/dashboard"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
            <a class="nav-link active" href="/admin"><i class="fa-solid fa-shield-halved"></i> Admin Panel</a>
            <a class="nav-link" onclick="logout()" href="#"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
        </div>
    </div>
</nav>

<div class="admin-header">
    <div class="container">
        <h1><i class="fa-solid fa-shield-halved me-3"></i>Admin Dashboard</h1>
    </div>
</div>

<div class="container">

    <div class="admin-section">
        <div class="section-header">
            <h3><i class="fa-solid fa-chart-pie me-2"></i>Platform Statistics</h3>
        </div>
        <div class="row g-4" id="stats-grid">
            <div class="col-12 text-center p-5">
                <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading Stats...</span></div>
            </div>
        </div>
    </div>

    <div class="admin-section">
        <div class="section-header">
            <h3><i class="fa-solid fa-gift me-2"></i>Donation Management</h3>
        </div>

        <ul class="nav nav-tabs" id="donationTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="item-approval-tab" data-bs-toggle="tab" data-bs-target="#item-approval" type="button" role="tab">
                    Item Approvals <span class="badge bg-warning ms-1" id="pendingItemsBadge">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="request-approval-tab" data-bs-toggle="tab" data-bs-target="#request-approval" type="button" role="tab">
                    Request Approvals <span class="badge bg-warning ms-1" id="pendingRequestsBadge">0</span>
                </button>
            </li>
        </ul>

        <div class="tab-content" id="donationTabsContent">
            <div class="tab-pane fade show active" id="item-approval" role="tabpanel">
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                        <tr>
                            <th>Image</th><th>Item</th><th>Donor</th><th>Address</th><th>Status</th><th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="pending-items-table"></tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="request-approval" role="tabpanel">
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                        <tr>
                            <th>Item</th><th>Requester</th><th>Donor</th><th>Status</th><th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="pending-requests-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-section">
        <div class="section-header">
            <h3><i class="fa-solid fa-right-left me-2"></i>Exchange Requests Management</h3>
        </div>
        <div class="table-responsive">
            <table class="table align-middle">
                <thead>
                <tr>
                    <th>Target Product</th><th>Exchange Item</th><th>Requester</th><th>Status</th><th>Actions</th>
                </tr>
                </thead>
                <tbody id="exchangeRequestsTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <div class="admin-section">
        <div class="section-header">
            <h3><i class="fa-solid fa-boxes-stacked me-2"></i>Product Listing Approvals (Resell/Exchange)</h3>
        </div>
        <div class="table-responsive">
            <table class="table align-middle">
                <thead>
                <tr>
                    <th>Image</th><th>Product</th><th>User</th><th>Type</th><th>Status</th><th>Actions</th>
                </tr>
                </thead>
                <tbody id="pendingProductsTableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="admin-section">
        <div class="section-header">
            <h3><i class="fa-solid fa-users-gear me-2"></i>User Management</h3>
        </div>
        <div class="table-responsive">
            <table class="table align-middle">
                <thead>
                <tr>
                    <th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Actions</th>
                </tr>
                </thead>
                <tbody id="usersTableBody"></tbody>
            </table>
        </div>
    </div>

</div>

<div class="modal fade" id="rejectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rejection Reason</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="rejectionReason" class="form-label">Reason for rejection:</label>
                    <textarea class="form-control" id="rejectionReason" rows="4" placeholder="Enter rejection reason..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmRejectBtn">Confirm Rejection</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
    const token = localStorage.getItem('jwtToken');
    let currentExchangeRequests = [];
    let currentRejectId = null;
    let currentRejectionType = null; // 'PRODUCT' or 'EXCHANGE' or 'DONATION_ITEM' or 'DONATION_REQUEST'

    // --- Helper Functions ---
    const apiHeaders = {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
    };

    function showNotification(message, type = 'info') {
        alert(`${type.toUpperCase()}: ${message}`);
    }

    function getStatusBadge(status) {
        if (!status) return '<span class="badge bg-secondary">Unknown</span>';
        switch(status) {
            case 'PENDING': return '<span class="badge bg-warning text-dark">Pending</span>';
            case 'APPROVED': return '<span class="badge bg-success">Approved</span>';
            case 'REJECTED': return '<span class="badge bg-danger">Rejected</span>';
            case 'CLAIMED': return '<span class="badge bg-info">Claimed</span>';
            case 'CONFIRMED': return '<span class="badge bg-primary">Confirmed Sale</span>';
            default: return `<span class="badge bg-secondary">${status}</span>`;
        }
    }

    function logout() {
        localStorage.removeItem('jwtToken');
        window.location.href = '/';
    }

    // --- Core Data Loading Function (Loads all pending views) ---
    function loadAllData() {
        if (!token) {
            window.location.href = '/login';
            return;
        }
        loadStats();
        loadPendingDonationItems();
        loadPendingDonationRequests();
        loadPendingProducts();
        loadExchangeRequests();
        loadUsers();
    }

    // --- 1. Platform Stats ---
    async function loadStats() {
        const statsGrid = document.getElementById('stats-grid');
        statsGrid.innerHTML = '';
        try {
            const [donateRes, productRes, userRes] = await Promise.all([
                fetch('/api/admin/donations/stats', { headers: apiHeaders }).then(res => res.json()),
                fetch('/api/admin/products/stats', { headers: apiHeaders }).then(res => res.json()),
                fetch('/api/admin/stats', { headers: apiHeaders }).then(res => res.json())
            ]);

            statsGrid.innerHTML = `
                <div class="col-md-3"><div class="stat-card"><div class="stat-number">${userRes.totalUsers || 0}</div><div class="stat-label">Total Users</div></div></div>
                <div class="col-md-3"><div class="stat-card"><div class="stat-number">${productRes.pendingProducts || 0}</div><div class="stat-label">Pending Products</div></div></div>
                <div class="col-md-3"><div class="stat-card"><div class="stat-number">${donateRes.pendingItems || 0}</div><div class="stat-label">Pending Donations</div></div></div>
                <div class="col-md-3"><div class="stat-card"><div class="stat-number">${donateRes.pendingRequests || 0}</div><div class="stat-label">Pending Don. Requests</div></div></div>
            `;

            document.getElementById('pendingItemsBadge').textContent = donateRes.pendingItems || 0;
            document.getElementById('pendingRequestsBadge').textContent = donateRes.pendingRequests || 0;

        } catch (err) {
            console.error("Error loading stats:", err);
            statsGrid.innerHTML = '<div class="col-12"><div class="alert alert-danger">Failed to load platform stats. Check console.</div></div>';
        }
    }

    // --- 2. Donation Item Approvals ---
    async function loadPendingDonationItems() {
        const tableBody = document.getElementById('pending-items-table');
        try {
            const res = await fetch('/api/admin/donations/items/pending', { headers: apiHeaders });
            if (!res.ok) throw new Error('Failed to fetch pending items');
            const items = await res.json();

            tableBody.innerHTML = items.length === 0 ? '<tr><td colspan="6" class="text-center text-muted p-4">No pending donation items to approve.</td></tr>' :
                items.map(item => `
                <tr>
                    <td><img src="${item.imageUrl || ''}" alt="${item.itemName}" class="product-image" onerror="this.src='https://via.placeholder.com/50'"></td>
                    <td><strong>${item.itemName}</strong><br><small class="text-muted">${item.itemType} (${item.itemCondition})</small></td>
                    <td>${item.donor?.firstName || 'N/A'} ${item.donor?.lastName || ''}<br><small class="text-muted">${item.donor?.email || ''}</small></td>
                    <td>${item.pickupAddress}</td>
                    <td>${getStatusBadge(item.status)}</td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="approveDonationItem(${item.id})">Approve</button>
                        <button class="btn btn-danger btn-sm ms-1" onclick="showRejectionModal(${item.id}, 'DONATION_ITEM')">Reject</button>
                    </td>
                </tr>
            `).join('');
        } catch (err) {
            console.error("Error loading pending donation items:", err);
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger p-4">Error loading data.</td></tr>';
        }
    }

    // --- 3. Donation Request Approvals ---
    async function loadPendingDonationRequests() {
        const tableBody = document.getElementById('pending-requests-table');
        try {
            const res = await fetch('/api/admin/donations/requests/pending', { headers: apiHeaders });
            if (!res.ok) throw new Error('Failed to fetch pending requests');
            const requests = await res.json();

            tableBody.innerHTML = requests.length === 0 ? '<tr><td colspan="5" class="text-center text-muted p-4">No pending donation requests to approve.</td></tr>' :
                requests.map(req => `
                <tr>
                    <td><strong>${req.donateItem?.itemName || 'N/A'}</strong><br><small class="text-muted">Item ID: ${req.donateItem?.id || 'N/A'}</small></td>
                    <td>${req.receiver?.firstName || 'N/A'} ${req.receiver?.lastName || ''}<br><small class="text-muted">${req.receiver?.email || ''}</small></td>
                    <td>${req.donateItem?.donor?.firstName || 'N/A'} ${req.donateItem?.donor?.lastName || ''}<br><small class="text-muted">${req.donateItem?.donor?.email || ''}</small></td>
                    <td>${getStatusBadge(req.status)}</td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="approveDonationRequest(${req.id})">Approve</button>
                        <button class="btn btn-danger btn-sm ms-1" onclick="showRejectionModal(${req.id}, 'DONATION_REQUEST')">Reject</button>
                    </td>
                </tr>
            `).join('');
        } catch (err) {
            console.error("Error loading pending requests:", err);
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger p-4">Error loading data.</td></tr>';
        }
    }

    // --- 4. Exchange Request Approvals ---
    async function loadExchangeRequests() {
        const tableBody = document.getElementById('exchangeRequestsTableBody');
        try {
            const res = await fetch('/api/admin/exchange-requests?status=PENDING', { headers: apiHeaders });
            if (!res.ok) throw new Error('Failed to fetch exchange requests');
            const requests = await res.json();
            currentExchangeRequests = requests;

            tableBody.innerHTML = requests.length === 0 ? '<tr><td colspan="5" class="text-center text-muted p-4">No pending exchange requests to approve.</td></tr>' :
                requests.map(req => `
                <tr>
                    <td><strong>${req.targetProduct?.name || 'N/A'}</strong><br><small class="text-muted">Owner: ${req.targetProduct?.user?.firstName || 'N/A'}</small></td>
                    <td><strong>${req.exchangeItemName}</strong><br><small class="text-muted">${req.exchangeItemCategory}</small></td>
                    <td>${req.requester?.firstName || 'N/A'} ${req.requester?.lastName || ''}<br><small class="text-muted">${req.requester?.email || ''}</small></td>
                    <td>${getStatusBadge(req.status)}</td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="approveExchangeRequest(${req.id})">Approve</button>
                        <button class="btn btn-danger btn-sm ms-1" onclick="showRejectionModal(${req.id}, 'EXCHANGE')">Reject</button>
                    </td>
                </tr>
            `).join('');
        } catch (err) {
            console.error("Error loading exchange requests:", err);
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger p-4">Error loading exchange requests.</td></tr>';
        }
    }

    // --- 5. Product Listing Approvals ---
    async function loadPendingProducts() {
        const tableBody = document.getElementById('pendingProductsTableBody');
        try {
            const res = await fetch('/api/admin/products/pending', { headers: apiHeaders });
            if (!res.ok) throw new Error('Failed to fetch pending products');
            const products = await res.json();

            if (products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted p-4">No pending product listings to approve.</td></tr>';
                return;
            }

            tableBody.innerHTML = products.map(product => {
                const userFirst = product.userFirstName || (product.user ? product.user.firstName : 'N/A');
                const userLast = product.userLastName || (product.user ? product.user.lastName : '');
                const userEmail = product.userEmail || (product.user ? product.user.email : 'N/A');
                const img = product.imagePath || 'https://via.placeholder.com/50';

                return `
                <tr>
                    <td><img src="${img}" alt="${product.name}" class="product-image" onerror="this.src='https://via.placeholder.com/50'"></td>
                    <td><strong>${product.name}</strong><br><small class="text-muted">${product.category}</small></td>
                    <td>${userFirst} ${userLast}<br><small class="text-muted">${userEmail}</small></td>
                    <td><span class="badge bg-info">${product.type}</span></td>
                    <td>${getStatusBadge(product.status)}</td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="approveProduct(${product.id})">Approve</button>
                        <button class="btn btn-danger btn-sm ms-1" onclick="showRejectionModal(${product.id}, 'PRODUCT')">Reject</button>
                    </td>
                </tr>
            `}).join('');
        } catch (err) {
            console.error("Error loading pending products:", err);
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger p-4">Error loading product listings.</td></tr>';
        }
    }

    // --- 6. User Management ---
    async function loadUsers() {
        const tableBody = document.getElementById('usersTableBody');
        try {
            const res = await fetch('/api/admin/users', { headers: apiHeaders });
            if (!res.ok) throw new Error('Failed to fetch users');
            const users = await res.json();

            tableBody.innerHTML = users.length === 0 ? '<tr><td colspan="5" class="text-center text-muted p-4">No users found.</td></tr>' :
                users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.firstName} ${user.lastName}</td>
                    <td>${user.email}</td>
                    <td>${user.admin ? '<span class="badge bg-primary">ADMIN</span>' : '<span class="badge bg-secondary">USER</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleAdmin(${user.id}, ${!user.admin})">
                            ${user.admin ? 'Remove Admin' : 'Make Admin'}
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (err) {
            console.error("Error loading users:", err);
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger p-4">Error loading users.</td></tr>';
        }
    }

    // --- ACTIONS: Common Rejection Handler (Modal Logic) ---
    const rejectionModal = new bootstrap.Modal(document.getElementById('rejectionModal'));

    function showRejectionModal(id, type) {
        currentRejectId = id;
        currentRejectionType = type;
        document.getElementById('rejectionReason').value = '';
        document.getElementById('confirmRejectBtn').onclick = handleConfirmRejection;
        rejectionModal.show();
    }

    function handleConfirmRejection() {
        const reason = document.getElementById('rejectionReason').value.trim();
        if (!reason) {
            showNotification('Rejection requires a reason.', 'warning');
            return;
        }
        rejectionModal.hide();

        if (currentRejectionType === 'PRODUCT') {
            rejectProduct(currentRejectId, reason);
        } else if (currentRejectionType === 'EXCHANGE') {
            rejectExchangeRequest(currentRejectId, reason);
        } else if (currentRejectionType === 'DONATION_ITEM') {
            rejectDonationItem(currentRejectId, reason);
        } else if (currentRejectionType === 'DONATION_REQUEST') {
            rejectDonationRequest(currentRejectId, reason);
        }
    }

    // --- ACTIONS: DONATION ITEMS ---
    async function approveDonationItem(id) {
        if (!confirm('Approve this donation item? It will become available for request.')) return;
        try {
            await fetch(`/api/admin/donations/items/${id}/approve`, { method: 'POST', headers: apiHeaders });
            showNotification('Item approved!', 'success');
            loadAllData();
        } catch (err) {
            showNotification('Error approving item.', 'danger');
        }
    }
    async function rejectDonationItem(id, reason) {
        try {
            await fetch(`/api/admin/donations/items/${id}/reject`, {
                method: 'POST',
                headers: apiHeaders,
                body: JSON.stringify({ reason: reason })
            });
            showNotification('Item rejected.', 'success');
            loadAllData();
        } catch (err) {
            showNotification('Error rejecting item.', 'danger');
        }
    }

    // --- ACTIONS: DONATION REQUESTS ---
    async function approveDonationRequest(id) {
        if (!confirm('Approve this donation request? This will mark the item as CLAIMED.')) return;
        try {
            await fetch(`/api/admin/donations/requests/${id}/approve`, { method: 'POST', headers: apiHeaders });
            showNotification('Request approved!', 'success');
            loadAllData();
        } catch (err) {
            showNotification('Error approving request.', 'danger');
        }
    }
    async function rejectDonationRequest(id, reason) {
        try {
            await fetch(`/api/admin/donations/requests/${id}/reject`, {
                method: 'POST',
                headers: apiHeaders,
                body: JSON.stringify({ reason: reason })
            });
            showNotification('Request rejected.', 'success');
            loadAllData();
        } catch (err) {
            showNotification('Error rejecting request.', 'danger');
        }
    }

    // --- ACTIONS: EXCHANGE REQUESTS ---
    async function approveExchangeRequest(id) {
        if (!confirm('Approve this exchange request?')) return;
        try {
            await fetch(`/api/admin/exchange-requests/${id}/approve`, { method: 'PUT', headers: apiHeaders });
            showNotification('Exchange request approved!', 'success');
            loadAllData();
        } catch (err) {
            showNotification('Error approving request. Check API status.', 'danger');
        }
    }
    async function rejectExchangeRequest(id, reason) {
        try {
            await fetch(`/api/admin/exchange-requests/${id}/reject`, {
                method: 'PUT',
                headers: apiHeaders,
                body: JSON.stringify({ rejectionReason: reason })
            });
            showNotification('Exchange request rejected.', 'success');
            loadAllData();
        } catch (err) {
            showNotification('Error rejecting request.', 'danger');
        }
    }


    // --- ACTIONS: PRODUCT LISTINGS (Resell/Exchange Item Approval) ---
    async function approveProduct(id) {
        if (!confirm('Approve this product listing?')) return;
        try {
            await fetch(`/api/admin/products/${id}/approve`, { method: 'POST', headers: apiHeaders });
            showNotification('Product approved!', 'success');
            loadAllData();
        } catch (err) {
            showNotification('Error approving product.', 'danger');
        }
    }
    async function rejectProduct(id, reason) {
        try {
            await fetch(`/api/admin/products/${id}/reject`, {
                method: 'POST',
                headers: apiHeaders,
                body: JSON.stringify({ rejectionReason: reason })
            });
            showNotification('Product rejected.', 'success');
            loadAllData();
        } catch (err) {
            showNotification('Error rejecting product.', 'danger');
        }
    }

    // --- ACTIONS: USERS ---
    async function toggleAdmin(userId, makeAdmin) {
        if (!confirm(`Are you sure?`)) return;
        try {
            await fetch(`/api/admin/users/${userId}/role`, {
                method: 'PUT',
                headers: apiHeaders,
                body: JSON.stringify({ isAdmin: makeAdmin })
            });
            showNotification('User role updated!', 'success');
            loadAllData();
        } catch (err) {
            showNotification('Error updating user role.', 'danger');
        }
    }

    // --- INITIAL LOAD ---
    document.addEventListener('DOMContentLoaded', loadAllData);
</script>
</body>
</html>
